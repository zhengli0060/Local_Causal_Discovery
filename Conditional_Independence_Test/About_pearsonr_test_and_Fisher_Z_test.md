## 📊 Pearsonr CI Test vs Fisher-Z CI Test

在**结构学习**和**高斯图模型**中，我们常常需要判断两个**连续变量**在给定其他变量条件下是否独立。Pearson 相关系数检验（Pearsonr CI Test）和 Fisher Z 检验（Fisher-Z CI Test）是最常见的两种方法，二者都基于变量之间的线性相关性，但检验方法和适用范围有所不同。

---

### 🔸 1. 方法概述

| 方法 | Pearsonr CI Test | Fisher-Z CI Test |
|------|------------------|------------------|
| 核心思想 | 利用 Pearson 相关系数 \( r \) 检验 \( H_0: \rho = 0 \) | 对 \( r \) 进行 Fisher Z 变换后基于标准正态分布检验 |
| 用途 | 判断变量 \( X \) 与 \( Y \) 是否（条件）独立 | 判断变量 \( X \) 与 \( Y \) 在给定 \( Z \) 下是否独立 |
| 变量类型 | 连续变量 | 连续变量（假设多元高斯分布） |
| 假设检验 | t 检验（小样本更稳健） | 正态检验（适合条件独立、样本足够） |
| 条件变量支持 | 仅适用于无条件检验 | 支持任意条件集合 \( Z \) |

---

### 🔸 2. 数学形式

#### ✅ Pearsonr  Test

用于两个变量 \( X \), \( Y \) 的相关性检验：
- 计算相关系数：
  \[
  r = \frac{\sum (x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum (x_i - \bar{x})^2 \sum (y_i - \bar{y})^2}}
  \]
- 检验统计量：
  \[
  t = \frac{r \sqrt{n - 2}}{\sqrt{1 - r^2}} \sim t(n - 2)
  \]
- 主要用于：**无条件相关性检验**

---

#### ✅ Fisher-Z CI Test

用于检验变量 \( X \) 与 \( Y \) 在条件集合 \( Z \) 下的独立性：

1. 首先对 \( X \) 和 \( Y \) 进行线性回归残差处理，得到**偏相关系数** \( r_{XY \mid Z} \)
2. 然后将 \( r_{XY \mid Z} \) 做 Fisher Z 变换：
   \[
   Z = \frac{1}{2} \ln\left(\frac{1 + r}{1 - r}\right)
   \]
3. Fisher Z 统计量的近似分布为：
   \[
   Z \sim \mathcal{N}\left(0, \frac{1}{n - |Z| - 3}\right)
   \]
   其中 \( |Z| \) 是条件集合的维度。

---

### 🔸 3. 理论对比

| 特性 | Pearsonr CI Test | Fisher-Z CI Test |
|------|------------------|------------------|
| 检验变量 | 两个变量（无条件） | 两个变量给定一个条件集合 |
| 样本量要求 | 小样本也可使用 | 需要较大样本，避免 \( n - |Z| - 3 \leq 0 \) |
| 假设分布 | \( t \) 分布 | 正态分布 |
| 适合变量分布 | 正态性假设较弱 | 需要假设多元高斯分布 |
| 精确性 | 简单情形足够精确 | 条件检验下更准确、理论严谨 |
| 在结构学习中是否主流 | ❌（仅限基础分析） | ✅（广泛用于 PC、GES、IC 等算法） |

---

### 🔸 4. 使用场景对比

| 应用场景 | 推荐方法 | 说明 |
|----------|-----------|------|
| 检验两个连续变量之间是否相关 | Pearsonr | 简单直接，不考虑条件变量 |
| 在贝叶斯网络或因果图中进行条件独立性检验 | **Fisher-Z** ✅ | 可扩展至任意条件集合 |
| 数据服从多元高斯分布 | Fisher-Z | 假设与检验一致，结果更可靠 |
| 样本量较小（如 < 30） | Pearsonr | t 检验在小样本下更稳定 |
| 高维数据、结构学习（如 PC 算法） | Fisher-Z ✅ | 与高斯图模型高度匹配 |
| 非线性关系或非正态分布 | ❌ 二者都不适合 | 可考虑 Kernel-based CI test（如 HSIC）或 Copula 方法 |

---

### 🔸 5. 总结一句话

> **Fisher-Z 是 Pearsonr 的扩展形式，适用于有条件集合时判断两个连续变量是否独立，是高斯图模型和结构学习中最常用的条件独立性检验工具；而 Pearsonr 仅适用于无条件相关性的基本检验。**

---

### 🔹 常用工具支持

- **R**：
  - `cor.test(x, y)`：Pearsonr 检验
  - `pcalg::gaussCItest()`：Fisher-Z 检验
- **Python**：
  - `scipy.stats.pearsonr()`：Pearsonr
  - `causal-learn`, `pgmpy` 等结构学习库内置 Fisher-Z

---

